// prisma/schema.prisma

// ======================
//  Datasource + Generator
// ======================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../server/node_modules/.prisma/client"
}

// ======================
//  Enums
// ======================

enum DraftMode {
  AUCTION
  DRAFT
}

enum DraftOrder {
  SNAKE
  LINEAR
}

// NEW: League roles for access control
enum LeagueRole {
  COMMISSIONER
  OWNER
  VIEWER
}

// ======================
//  Models
// ======================

model User {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  name      String?
  avatarUrl String?
  googleSub String  @unique
  isAdmin   Boolean @default(false)

  memberships LeagueMembership[]
  ownedTeams   Team[] @relation("TeamOwner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model League {
  id         Int        @id @default(autoincrement())
  name       String
  season     Int
  draftMode  DraftMode
  draftOrder DraftOrder?
  createdAt  DateTime   @default(now())

  // NEW: public viewer (no login) support
  isPublic   Boolean @default(false)
  publicSlug String? @unique

  // Relations
  teams       Team[]
  memberships LeagueMembership[]

  @@unique([name, season])
}

model LeagueMembership {
  id       Int       @id @default(autoincrement())
  leagueId Int
  userId   Int
  role     LeagueRole

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leagueId, userId])
  @@index([userId])
  @@index([leagueId])
}

model Team {
  id        Int      @id @default(autoincrement())
  leagueId  Int
  name      String
  owner     String?
  budget    Int      @default(400)
  createdAt DateTime @default(now())

  // NEW: stable team code + optional owner user link
  code        String?
  ownerUserId Int?
  ownerUser   User?   @relation("TeamOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  // Relations
  league        League            @relation(fields: [leagueId], references: [id])
  rosters       Roster[]
  stats         TeamStatsPeriod[]
  season        TeamStatsSeason?
  financeEvents FinanceLedger[]

  // Ensure team names are unique *within* a league
  @@unique([leagueId, name])

  // NEW: allow unique codes inside a league (null ok for existing rows)
  @@unique([leagueId, code])
}

model Player {
  id         Int      @id @default(autoincrement())
  mlbId      Int?
  name       String
  posPrimary String
  posList    String   // comma-separated for now
  createdAt  DateTime @default(now())

  rosters Roster[]
  lots    AuctionLot[]
}

model Period {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  startDate DateTime
  endDate   DateTime
  status    String

  teamStats TeamStatsPeriod[]
}

model TeamStatsPeriod {
  id       Int @id @default(autoincrement())
  teamId   Int
  periodId Int

  // Batting
  R   Int   @default(0)
  HR  Int   @default(0)
  RBI Int   @default(0)
  SB  Int   @default(0)
  AVG Float @default(0)

  // Pitching
  W    Int   @default(0)
  S    Int   @default(0) // saves
  ERA  Float @default(0)
  WHIP Float @default(0)
  K    Int   @default(0)

  // Misc
  gamesPlayed Int @default(0)

  team   Team   @relation(fields: [teamId], references: [id])
  period Period @relation(fields: [periodId], references: [id])

  @@unique([teamId, periodId])
}

model TeamStatsSeason {
  id     Int @id @default(autoincrement())
  teamId Int @unique

  // Batting
  R   Int   @default(0)
  HR  Int   @default(0)
  RBI Int   @default(0)
  SB  Int   @default(0)
  AVG Float @default(0)

  // Pitching
  W    Int   @default(0)
  S    Int   @default(0)
  ERA  Float @default(0)
  WHIP Float @default(0)
  K    Int   @default(0)

  gamesPlayed Int @default(0)

  team Team @relation(fields: [teamId], references: [id])
}

model Roster {
  id         Int       @id @default(autoincrement())
  teamId     Int
  playerId   Int
  acquiredAt DateTime  @default(now())
  releasedAt DateTime?
  source     String
  price      Int       @default(1)

  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])
}

model AuctionLot {
  id               Int      @id @default(autoincrement())
  playerId         Int
  nominatingTeamId Int
  status           String   // idle, nominating, bidding, closing, assigned
  startTs          DateTime @default(now())
  endTs            DateTime?
  finalPrice       Int?
  winnerTeamId     Int?

  player Player @relation(fields: [playerId], references: [id])
}

model AuctionBid {
  id     Int      @id @default(autoincrement())
  lotId  Int
  teamId Int
  amount Int
  ts     DateTime @default(now())
}

model FinanceLedger {
  id     Int      @id @default(autoincrement())
  teamId Int
  type   String // entry_fee, bonus, il_fee, auction_adjust, etc.
  amount Int
  reason String?
  ts     DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id])
}
