// prisma/schema.prisma

// ======================
//  Datasource + Generator
// ======================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../server/node_modules/.prisma/client"
}

// ======================
//  Enums
// ======================

enum DraftMode {
  AUCTION
  DRAFT
}

enum DraftOrder {
  SNAKE
  LINEAR
}

// NEW: League roles for access control
enum LeagueRole {
  COMMISSIONER
  OWNER
  VIEWER
}

enum TradeStatus {
  PROPOSED
  ACCEPTED
  REJECTED
  VETOED
  PROCESSED
  CANCELLED
}

enum AssetType {
  PLAYER
  BUDGET
  PICK
}

enum ClaimStatus {
  PENDING
  SUCCESS
  FAILED_OUTBID
  FAILED_INVALID
}

// ======================
//  Models
// ======================

model User {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  name         String?
  avatarUrl    String?
  googleSub    String? @unique
  yahooSub     String? @unique
  passwordHash String?

  resetToken        String?   @unique
  resetTokenExpires DateTime?

  isAdmin Boolean @default(false)

  memberships    LeagueMembership[]
  ownedTeams     Team[]             @relation("TeamOwner")
  teamOwnerships TeamOwnership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model League {
  id         Int         @id @default(autoincrement())
  name       String
  season     Int
  draftMode  DraftMode
  draftOrder DraftOrder?
  createdAt  DateTime    @default(now())

  isPublic   Boolean @default(false)
  publicSlug String? @unique

  // Trade Settings
  tradeReviewPolicy String @default("COMMISSIONER") // COMMISSIONER, LEAGUE_VOTE
  vetoThreshold     Int    @default(4)

  teams             Team[]
  memberships       LeagueMembership[]
  transactions      TransactionEvent[]
  historicalSeasons HistoricalSeason[]
  rules             LeagueRule[]
  trades            Trade[]

  @@unique([name, season])
}

// Dynamic Rules Management
model LeagueRule {
  id       Int    @id @default(autoincrement())
  leagueId Int
  league   League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  category String // "overview", "roster", "scoring", "draft", "trades", "bonuses", "payouts"
  key      String // "team_count", "budget", "keeper_count", etc.
  value    String // JSON string for complex values
  label    String // Display label for UI

  isLocked Boolean @default(false) // Locked after season start

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leagueId, category, key])
  @@index([leagueId])
}

model LeagueMembership {
  id       Int        @id @default(autoincrement())
  leagueId Int
  userId   Int
  role     LeagueRole

  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leagueId, userId])
  @@index([userId])
  @@index([leagueId])
}

// Multi-owner support (up to 2 owners per team)
model TeamOwnership {
  id     Int @id @default(autoincrement())
  teamId Int
  userId Int

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Team {
  id        Int      @id @default(autoincrement())
  leagueId  Int
  name      String
  owner     String?
  budget    Int      @default(400)
  createdAt DateTime @default(now())

  code        String?
  ownerUserId Int?
  ownerUser   User?   @relation("TeamOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)

  // Multi-owner support
  ownerships TeamOwnership[]

  // Link to prior year team for historical tracking
  priorTeamId Int?
  priorTeam   Team?  @relation("TeamHistory", fields: [priorTeamId], references: [id], onDelete: SetNull)
  nextTeams   Team[] @relation("TeamHistory")

  league        League            @relation(fields: [leagueId], references: [id])
  rosters       Roster[]
  stats         TeamStatsPeriod[]
  season        TeamStatsSeason?
  financeEvents FinanceLedger[]

  // ADD THIS:
  transactions TransactionEvent[]
  auctionBids  AuctionBid[]

  // Trade Relations
  proposedTrades     Trade[]     @relation("TradeProposer")
  tradeItemsSent     TradeItem[] @relation("TradeSender")
  tradeItemsReceived TradeItem[] @relation("TradeRecipient")

  // Waiver Relations
  waiverClaims WaiverClaim[]

  @@unique([leagueId, name])
  @@unique([leagueId, code])
}

model Player {
  id Int @id @default(autoincrement())

  // Canonical internal integration key (do not expose to UI).
  // Keep nullable for now to avoid breaking existing rows; Postgres UNIQUE allows many NULLs.
  mlbId Int? @unique

  name       String
  posPrimary String
  posList    String // comma-separated for now
  mlbTeam    String? // e.g. "LAD", "NYY"

  createdAt DateTime @default(now())

  rosters          Roster[]
  lots             AuctionLot[]
  aliases          PlayerAlias[]
  transactions     TransactionEvent[]
  tradeItems       TradeItem[]
  waiverClaimsAdd  WaiverClaim[]      @relation("ClaimAdd")
  waiverClaimsDrop WaiverClaim[]      @relation("ClaimDrop")

  @@index([name])
}

model PlayerAlias {
  id       Int @id @default(autoincrement())
  playerId Int

  // e.g. "onroto"
  source String

  // e.g. "NArenado", "HyeKim"
  alias String

  createdAt DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([source, alias])
  @@index([playerId])
  @@index([alias])
}

model TransactionEvent {
  id Int @id @default(autoincrement())

  // Your parser’s idempotency key (md5 over raw fields)
  rowHash String @unique

  leagueId Int
  season   Int

  // Best-effort parsed timestamps
  effDate     DateTime?
  submittedAt DateTime?

  // Raw strings from HTML (keep them for traceability/debugging)
  effDateRaw     String?
  submittedRaw   String?
  ogbaTeamName   String?
  playerAliasRaw String?
  mlbTeamAbbr    String?
  transactionRaw String?

  // Normalized “types” (optional, but useful)
  transactionType String?
  toPosition      String?

  // Joins (optional until mapped)
  teamId   Int?
  playerId Int?

  createdAt DateTime @default(now())

  league League  @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: SetNull)
  player Player? @relation(fields: [playerId], references: [id], onDelete: SetNull)

  @@index([leagueId, season])
  @@index([teamId])
  @@index([playerId])
  @@index([submittedAt])
}

model Period {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  startDate DateTime
  endDate   DateTime
  status    String

  teamStats TeamStatsPeriod[]
}

model TeamStatsPeriod {
  id       Int @id @default(autoincrement())
  teamId   Int
  periodId Int

  // Batting
  R   Int   @default(0)
  HR  Int   @default(0)
  RBI Int   @default(0)
  SB  Int   @default(0)
  AVG Float @default(0)

  // Pitching
  W    Int   @default(0)
  S    Int   @default(0) // saves
  ERA  Float @default(0)
  WHIP Float @default(0)
  K    Int   @default(0)

  // Misc
  gamesPlayed Int @default(0)

  team   Team   @relation(fields: [teamId], references: [id])
  period Period @relation(fields: [periodId], references: [id])

  @@unique([teamId, periodId])
}

model TeamStatsSeason {
  id     Int @id @default(autoincrement())
  teamId Int @unique

  // Batting
  R   Int   @default(0)
  HR  Int   @default(0)
  RBI Int   @default(0)
  SB  Int   @default(0)
  AVG Float @default(0)

  // Pitching
  W    Int   @default(0)
  S    Int   @default(0)
  ERA  Float @default(0)
  WHIP Float @default(0)
  K    Int   @default(0)

  gamesPlayed Int @default(0)

  team Team @relation(fields: [teamId], references: [id])
}

model Roster {
  id               Int       @id @default(autoincrement())
  teamId           Int
  playerId         Int
  acquiredAt       DateTime  @default(now())
  releasedAt       DateTime?
  source           String
  price            Int       @default(1)
  assignedPosition String?
  isKeeper         Boolean   @default(false)

  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])
}

model AuctionLot {
  id               Int       @id @default(autoincrement())
  playerId         Int
  nominatingTeamId Int
  status           String
  startTs          DateTime  @default(now())
  endTs            DateTime?
  finalPrice       Int?
  winnerTeamId     Int?

  player Player @relation(fields: [playerId], references: [id])

  bids AuctionBid[]

  @@index([playerId])
}

model AuctionBid {
  id     Int      @id @default(autoincrement())
  lotId  Int
  teamId Int
  amount Int
  ts     DateTime @default(now())

  lot  AuctionLot @relation(fields: [lotId], references: [id], onDelete: Cascade)
  team Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([lotId])
  @@index([teamId])
}

model FinanceLedger {
  id     Int      @id @default(autoincrement())
  teamId Int
  type   String // entry_fee, bonus, il_fee, auction_adjust, etc.
  amount Int
  reason String?
  ts     DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id])
}

// ======================
//  Trade & Waiver System
// ======================

model Trade {
  id          Int         @id @default(autoincrement())
  leagueId    Int
  proposerId  Int
  status      TradeStatus @default(PROPOSED)
  createdAt   DateTime    @default(now())
  expiresAt   DateTime?
  processedAt DateTime?

  items TradeItem[]

  league   League @relation(fields: [leagueId], references: [id])
  proposer Team   @relation("TradeProposer", fields: [proposerId], references: [id])

  @@index([leagueId])
  @@index([proposerId])
  @@index([status])
}

model TradeItem {
  id          Int       @id @default(autoincrement())
  tradeId     Int
  senderId    Int
  recipientId Int
  assetType   AssetType @default(PLAYER)

  // Asset References
  playerId  Int? // If PLAYER
  amount    Int? // If BUDGET or PICK (round)
  pickRound Int? // If PICK

  trade     Trade   @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  sender    Team    @relation("TradeSender", fields: [senderId], references: [id])
  recipient Team    @relation("TradeRecipient", fields: [recipientId], references: [id])
  player    Player? @relation(fields: [playerId], references: [id])

  @@index([tradeId])
  @@index([senderId])
  @@index([recipientId])
}

model WaiverClaim {
  id           Int         @id @default(autoincrement())
  teamId       Int
  playerId     Int // Player to ADD
  dropPlayerId Int? // Player to DROP (optional)
  bidAmount    Int // FAAB $
  priority     Int // User-defined order
  status       ClaimStatus @default(PENDING)
  processedAt  DateTime?
  createdAt    DateTime    @default(now())

  team       Team    @relation(fields: [teamId], references: [id])
  player     Player  @relation("ClaimAdd", fields: [playerId], references: [id])
  dropPlayer Player? @relation("ClaimDrop", fields: [dropPlayerId], references: [id])

  @@index([teamId])
  @@index([status])
}

// ======================
//  Historical Archive Models
// ======================

model HistoricalSeason {
  id       Int     @id @default(autoincrement())
  year     Int // e.g., 2024, 2023
  leagueId Int?
  league   League? @relation(fields: [leagueId], references: [id])

  periods   HistoricalPeriod[]
  standings HistoricalStanding[]

  createdAt DateTime @default(now())

  @@unique([year, leagueId])
  @@index([year])
}

model HistoricalPeriod {
  id           Int              @id @default(autoincrement())
  seasonId     Int
  season       HistoricalSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  periodNumber Int // 1-6
  startDate    DateTime?
  endDate      DateTime?

  stats HistoricalPlayerStat[]

  @@unique([seasonId, periodNumber])
  @@index([seasonId])
}

model HistoricalPlayerStat {
  id       Int              @id @default(autoincrement())
  periodId Int
  period   HistoricalPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  playerName String
  fullName   String? // Full display name - commissioner can override

  mlbId     String?
  teamCode  String // OGBA team code
  isPitcher Boolean

  // MLB player info
  position String? // Primary position from MLB API (e.g., SS, CF, P)
  mlbTeam  String? // Current MLB team name

  // Hitting stats
  AB  Int?
  H   Int?
  R   Int?
  HR  Int?
  RBI Int?
  SB  Int?
  AVG Float?
  GS  Int? // Grand Slams

  // Pitching stats
  W    Int?
  SV   Int?
  K    Int?
  IP   Float?
  ER   Int?
  ERA  Float?
  WHIP Float?
  SO   Int? // Shut Outs

  draftDollars Int?
  isKeeper     Boolean @default(false)

  @@index([periodId, teamCode])
  @@index([periodId])
}

model HistoricalStanding {
  id       Int              @id @default(autoincrement())
  seasonId Int
  season   HistoricalSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  teamCode String
  teamName String

  // Category scores for the SEASON
  R_score    Int?
  HR_score   Int?
  RBI_score  Int?
  SB_score   Int?
  AVG_score  Int?
  W_score    Int?
  SV_score   Int?
  K_score    Int?
  ERA_score  Int?
  WHIP_score Int?

  totalScore Int
  finalRank  Int

  @@unique([seasonId, teamCode])
  @@index([seasonId])
}

model RosterEntry {
  id              Int      @id @default(autoincrement())
  year            Int      @default(2025)
  teamCode        String
  playerName      String
  position        String
  mlbTeam         String?
  acquisitionCost Int      @default(0)
  createdAt       DateTime @default(now())
}
